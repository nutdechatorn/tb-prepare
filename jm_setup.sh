#!/bin/bash

# р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╕Ир╕░р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З OpenJDK 17 р╣Бр╕ер╕░ Apache Maven 3.8.8 р╕Ър╕Щ Ubuntu
# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Гр╕лр╣Йр╣Бр╕Щр╣Ир╣Гр╕Ир╕зр╣Ир╕▓р╕Др╕╕р╕Ур╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╕Фр╣Йр╕зр╕вр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Чр╕╡р╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М sudo

echo "ЁЯФД р╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕гр╕░р╕Ър╕зр╕Щр╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Java р╣Бр╕ер╕░ Maven р╕кр╕│р╕лр╕гр╕▒р╕Ъ ThingsBoard CE"

# 1. р╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕ер╕┤р╕кр╕Хр╣Мр╣Бр╕ер╕░р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ
echo "ЁЯУж р╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕ер╕┤р╕кр╕Хр╣Мр╣Бр╕ер╕░р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ..."
sudo apt update -y
sudo apt upgrade -y
sudo apt install -y wget curl unzip git

# 2. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З OpenJDK 17
echo "тШХ р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З OpenJDK 17..."
sudo apt install -y openjdk-17-jdk

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Java
JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}')
echo "тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Java р╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щ: $JAVA_VERSION"

# 3. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Git (р╕лр╕▓р╕Бр╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З)
echo "ЁЯРЩ р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Git..."
sudo apt install -y git

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Git
GIT_VERSION=$(git --version)
echo "тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Git р╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щ: $GIT_VERSION"

# 4. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Apache Maven 3.8.8
echo "ЁЯУж р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Apache Maven 3.8.8..."

# р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щр╕Вр╕нр╕З Maven р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
MAVEN_VERSION=3.8.8
MAVEN_DIR=/opt/apache-maven-$MAVEN_VERSION
MAVEN_TAR=apache-maven-$MAVEN_VERSION-bin.tar.gz
MAVEN_DOWNLOAD_URL=https://dlcdn.apache.org/maven/maven-3/$MAVEN_VERSION/binaries/$MAVEN_TAR

# р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф Maven
cd /tmp
wget $MAVEN_DOWNLOAD_URL

# р╣Бр╕Хр╕Бр╣Др╕Яр╕ер╣М
sudo tar -xzvf $MAVEN_TAR -C /opt

# р╕кр╕гр╣Йр╕▓р╕З symbolic link р╕кр╕│р╕лр╕гр╕▒р╕Ъ Maven
sudo ln -sfn /opt/apache-maven-$MAVEN_VERSION /opt/maven

# р╕ер╕Ър╣Др╕Яр╕ер╣М tar.gz р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Ар╕кр╕гр╣Зр╕И
rm -f $MAVEN_TAR

# 5. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕┤р╣Ир╕Зр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕б
echo "ЁЯЫая╕П р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕┤р╣Ир╕Зр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕б JAVA_HOME р╣Бр╕ер╕░ MAVEN_HOME..."

# р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Вр╕Ыр╕гр╣Др╕Яр╕ер╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ъ Java
sudo bash -c 'cat <<EOL > /etc/profile.d/jdk.sh
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-arm64
export PATH=\$JAVA_HOME/bin:\$PATH
EOL'

# р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Вр╕Ыр╕гр╣Др╕Яр╕ер╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ъ Maven
sudo bash -c 'cat <<EOL > /etc/profile.d/maven.sh
export MAVEN_HOME=/opt/maven
export PATH=\$MAVEN_HOME/bin:\$PATH
EOL'

# р╕Чр╕│р╣Гр╕лр╣Йр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╣Ар╕лр╕ер╣Ир╕▓р╕Щр╕╡р╣Йр╕кр╕▓р╕бр╕▓р╕гр╕Цр╕гр╕▒р╕Щр╣Др╕Фр╣Й
sudo chmod +x /etc/profile.d/jdk.sh
sudo chmod +x /etc/profile.d/maven.sh

# р╣Вр╕лр╕ер╕Фр╣Вр╕Ыр╕гр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣И

cd\

source /etc/profile.d/jdk.sh
source /etc/profile.d/maven.sh

# 6. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Maven
MAVEN_VERSION_INSTALLED=$(mvn -version | awk '/Apache Maven/ {print $3}')
echo "тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Maven р╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щ: $MAVEN_VERSION_INSTALLED"

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ JAVA_HOME р╣Бр╕ер╕░ MAVEN_HOME р╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
echo "ЁЯУВ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕┤р╣Ир╕Зр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕б..."
echo "JAVA_HOME: $JAVA_HOME"
echo "MAVEN_HOME: $MAVEN_HOME"

echo "ЁЯОЙ р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Java р╣Бр╕ер╕░ Maven р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╣Бр╕ер╣Йр╕з! р╕Др╕╕р╕Ур╕Юр╕гр╣Йр╕нр╕бр╕Чр╕╡р╣Ир╕Ир╕░ Build р╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б ThingsBoard CE р╣Др╕Фр╣Йр╣Бр╕ер╣Йр╕з."

# р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Чр╣Ар╕Чр╕нр╕гр╣Мр╕бр╕┤р╕Щр╕▒р╕ер╕лр╕гр╕╖р╕нр╕гр╕░р╕Ър╕Ъ
echo "ЁЯФФ р╣Бр╕Щр╕░р╕Щр╕│: р╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Чр╣Ар╕Чр╕нр╕гр╣Мр╕бр╕┤р╕Щр╕▒р╕ер╕лр╕гр╕╖р╕нр╕гр╕░р╕Ър╕Ър╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕бр╕╡р╕Ьр╕ер╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М."
