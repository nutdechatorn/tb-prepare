#!/bin/bash

# ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Java ‡πÅ‡∏•‡∏∞ Maven ‡∏ö‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Ubuntu
# ‡∏´‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ "Java & maven ready for build TB"
# ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

echo "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Java ‡πÅ‡∏•‡∏∞ Maven..."

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
REQUIRED_JAVA_VERSION=11
REQUIRED_MAVEN_VERSION=3.6.3

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
version_ge() {
    # ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
    # ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 0 ‡∏´‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏£‡∏Å >= ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
    # ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 1 ‡∏´‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏£‡∏Å < ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
    [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$2" ]
}

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Java
if command -v java >/dev/null 2>&1; then
    JAVA_VERSION_FULL=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}')
    # ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
    JAVA_VERSION_MAJOR=$(echo "$JAVA_VERSION_FULL" | awk -F. '{print $1}')
    
    # ‡∏´‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô "1", ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á Java 8 ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    if [ "$JAVA_VERSION_MAJOR" = "1" ]; then
        JAVA_VERSION_MAJOR=$(echo "$JAVA_VERSION_FULL" | awk -F. '{print $2}')
    fi

    echo "‚úÖ ‡∏û‡∏ö Java ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô $JAVA_VERSION_FULL"

    if version_ge "$JAVA_VERSION_MAJOR" "$REQUIRED_JAVA_VERSION"; then
        JAVA_OK=true
    else
        echo "‚ùå Java ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô $REQUIRED_JAVA_VERSION ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ"
        JAVA_OK=false
    fi
else
    echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Java ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
    JAVA_OK=false
fi

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Maven
if command -v mvn >/dev/null 2>&1; then
    MAVEN_VERSION_FULL=$(mvn -version | awk '/Apache Maven/ {print $3}')
    echo "‚úÖ ‡∏û‡∏ö Maven ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô $MAVEN_VERSION_FULL"

    if version_ge "$MAVEN_VERSION_FULL" "$REQUIRED_MAVEN_VERSION"; then
        MAVEN_OK=true
    else
        echo "‚ùå Maven ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô $REQUIRED_MAVEN_VERSION ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ"
        MAVEN_OK=false
    fi
else
    echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Maven ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
    MAVEN_OK=false
fi

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
if [ "$JAVA_OK" = true ] && [ "$MAVEN_OK" = true ]; then
    echo "üéâ Java & maven ready for build TB"
    exit 0
else
    echo "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Java ‡∏´‡∏£‡∏∑‡∏≠ Maven ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà"
    exit 1
fi
